# 🚀 Deployment Guide: Poker AI FastAPI Backend

## Overview

This guide shows you how to deploy your Poker AI FastAPI backend to the cloud so your Next.js frontend can access it.

**Two options:**
1. **Render** (Recommended) - Easier, free tier available
2. **Railway** - Also good, similar pricing

**Total time:** 30-45 minutes  
**Cost:** $0-7/month (free tier available)

---

## Prerequisites

Before deploying, you need:

✅ All files in one directory:
- `aiplayer.py`
- `cfr_trainer.py`
- `fastapi_backend.py`
- `requirements.txt`
- `cfr_strategies.pkl` (generated by running `python cfr_trainer.py`)

✅ A GitHub account (free)  
✅ A Render or Railway account (free)

---

## Step 1: Generate Strategies (CRITICAL)

**You MUST do this first!** The backend won't work without trained strategies.

```bash
# Navigate to your project directory
cd /path/to/your/poker-ai

# Train the AI (takes 2-5 minutes)
python cfr_trainer.py

# Verify the file was created
ls -lh cfr_strategies.pkl
# Should show something like: -rw-r--r--  1 user  staff   15K Oct 13 10:30 cfr_strategies.pkl
```

✅ You should now have `cfr_strategies.pkl` in your directory.

---

## Step 2: Test Locally

Before deploying, make sure everything works:

```bash
# Install dependencies
pip install -r requirements.txt

# Run tests
python test_complete.py

# You should see:
# ✅ All tests passed! Your poker AI is ready to deploy!

# Start the server locally
python fastapi_backend.py

# Open another terminal and test:
curl http://localhost:8000/health
# Should return: {"status":"healthy","ai_loaded":true,"version":"1.0.0"}
```

If tests fail, fix issues before deploying!

---

## Step 3: Push to GitHub

```bash
# Initialize git (if not already done)
git init

# Add files
git add aiplayer.py cfr_trainer.py fastapi_backend.py requirements.txt cfr_strategies.pkl test_complete.py

# Commit
git commit -m "Initial commit: Poker AI backend"

# Create repo on GitHub (go to github.com, click "New Repository")
# Name it "poker-ai-backend"

# Push to GitHub
git remote add origin https://github.com/YOUR_USERNAME/poker-ai-backend.git
git branch -M main
git push -u origin main
```

✅ Your code is now on GitHub!

---

## Option A: Deploy to Render (Recommended)

### A1. Create Render Account

1. Go to https://render.com
2. Sign up with GitHub (easiest)
3. Verify your email

### A2. Create Web Service

1. Click **"New +"** → **"Web Service"**
2. Connect your GitHub repo: `poker-ai-backend`
3. Configure:

```
Name: poker-ai-backend
Environment: Python 3
Region: Oregon (US West) or closest to you
Branch: main

Build Command: pip install -r requirements.txt
Start Command: uvicorn fastapi_backend:app --host 0.0.0.0 --port $PORT
```

4. Choose plan: **Free** (for testing) or **Starter ($7/month)** (for production)

### A3. Deploy

1. Click **"Create Web Service"**
2. Wait 5-10 minutes for deployment
3. Render will show you the URL: `https://poker-ai-backend.onrender.com`

### A4. Test Deployment

```bash
# Test health endpoint
curl https://poker-ai-backend.onrender.com/health

# Should return:
# {"status":"healthy","ai_loaded":true,"version":"1.0.0"}
```

✅ Your API is live!

### A5. Test Strategy Endpoint

```bash
# Test getting a strategy
curl -X POST https://poker-ai-backend.onrender.com/strategy \
  -H "Content-Type: application/json" \
  -d '{
    "stage": "preflop",
    "hole_cards": ["As", "Kh"],
    "board": []
  }'

# Should return:
# {
#   "strategy": {"fold": 0.05, "call": 0.25, "raise": 0.70},
#   "recommended_action": "raise",
#   "bucket": 8,
#   "explanation": null
# }
```

✅ Your poker AI is working!

---

## Option B: Deploy to Railway

### B1. Create Railway Account

1. Go to https://railway.app
2. Sign up with GitHub
3. Verify your email

### B2. Create New Project

1. Click **"New Project"**
2. Select **"Deploy from GitHub repo"**
3. Choose: `poker-ai-backend`

### B3. Configure

Railway auto-detects Python projects, but verify:

1. Click **"Settings"**
2. Set:
```
Build Command: pip install -r requirements.txt
Start Command: uvicorn fastapi_backend:app --host 0.0.0.0 --port $PORT
```

### B4. Deploy

1. Click **"Deploy"**
2. Wait 5-10 minutes
3. Railway generates a URL: `https://poker-ai-backend.up.railway.app`

### B5. Test (same as Render)

```bash
curl https://poker-ai-backend.up.railway.app/health
```

✅ Your API is live on Railway!

---

## Step 4: Configure CORS for Your Frontend

Your Next.js app needs permission to call the API. Update `fastapi_backend.py`:

```python
# In fastapi_backend.py, find this section:
allow_origins=[
    "http://localhost:3000",  # Local development
    "https://yourdomain.com",  # Your production domain - CHANGE THIS!
    "*"  # Remove this in production
],
```

**Change to:**
```python
allow_origins=[
    "http://localhost:3000",  # Local dev
    "https://your-actual-app.vercel.app",  # Your deployed Next.js app
],
```

Then commit and push:
```bash
git add fastapi_backend.py
git commit -m "Update CORS for production"
git push
```

Render/Railway will auto-redeploy in ~5 minutes.

---

## Step 5: Connect to Your Next.js Frontend

### Create API Client

In your Next.js app (Supalaunch), create `lib/poker-api.ts`:

```typescript
// lib/poker-api.ts
const API_URL = process.env.NEXT_PUBLIC_POKER_API_URL || 'http://localhost:8000';

export interface PokerHand {
  stage: 'preflop' | 'flop' | 'turn' | 'river';
  hole_cards: [string, string];
  board: string[];
}

export interface StrategyResponse {
  strategy: Record<string, number>;
  recommended_action: string;
  bucket: number;
  explanation: string | null;
}

export async function getStrategy(hand: PokerHand): Promise<StrategyResponse> {
  const response = await fetch(`${API_URL}/strategy`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(hand),
  });

  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }

  return response.json();
}

export async function getAction(hand: PokerHand): Promise<string> {
  const response = await fetch(`${API_URL}/action`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(hand),
  });

  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }

  const data = await response.json();
  return data.action;
}
```

### Add Environment Variable

In your Next.js app, create `.env.local`:

```bash
# .env.local
NEXT_PUBLIC_POKER_API_URL=https://poker-ai-backend.onrender.com
```

### Use in Component

```typescript
// app/coach/page.tsx (example)
'use client';

import { useState } from 'react';
import { getStrategy } from '@/lib/poker-api';

export default function CoachPage() {
  const [strategy, setStrategy] = useState(null);

  const handleGetStrategy = async () => {
    const result = await getStrategy({
      stage: 'preflop',
      hole_cards: ['As', 'Kh'],
      board: []
    });
    setStrategy(result);
  };

  return (
    <div>
      <button onClick={handleGetStrategy}>Get Strategy</button>
      {strategy && (
        <div>
          <h2>Recommended: {strategy.recommended_action}</h2>
          <p>Fold: {(strategy.strategy.fold * 100).toFixed(1)}%</p>
          <p>Call: {(strategy.strategy.call * 100).toFixed(1)}%</p>
          <p>Raise: {(strategy.strategy.raise * 100).toFixed(1)}%</p>
        </div>
      )}
    </div>
  );
}
```

---

## Step 6: Monitor Your Deployment

### Render Dashboard

1. Go to https://dashboard.render.com
2. Click your service
3. View logs, metrics, etc.

### Railway Dashboard

1. Go to https://railway.app/dashboard
2. Click your project
3. View logs, deployments, etc.

### Test Endpoints

Visit your deployed API docs:
- Render: `https://poker-ai-backend.onrender.com/docs`
- Railway: `https://poker-ai-backend.up.railway.app/docs`

This shows interactive API documentation!

---

## Troubleshooting

### Issue: "AI player not loaded"

**Problem:** `cfr_strategies.pkl` is missing

**Solution:**
```bash
# Make sure you pushed the file to GitHub
git add cfr_strategies.pkl
git commit -m "Add trained strategies"
git push

# Trigger redeploy on Render/Railway
```

### Issue: CORS errors in browser console

**Problem:** Frontend can't call API due to CORS

**Solution:** Update `allow_origins` in `fastapi_backend.py` (see Step 4)

### Issue: 503 errors

**Problem:** Server is starting up or crashed

**Solution:**
1. Check logs in Render/Railway dashboard
2. Look for Python errors
3. Make sure `requirements.txt` has all dependencies

### Issue: Slow response times

**Problem:** Free tier servers sleep after inactivity

**Solution:**
- Upgrade to paid tier ($7/month)
- Or use a ping service to keep it awake

---

## Next Steps

✅ Backend deployed  
✅ Frontend connected  
✅ Basic poker AI working  

**Now add:**

1. **Claude API Coaching** - Natural language explanations
   ```bash
   pip install anthropic
   # Add to fastapi_backend.py /coaching endpoint
   ```

2. **Hand History Analysis** - Let users upload hands
   ```python
   @app.post("/analyze_hand")
   async def analyze_hand(hand_history: str):
       # Parse hand, get strategy for each decision
       # Compare player action vs GTO
       # Return analysis
   ```

3. **Session Tracking** - Save user's hands to database
   ```python
   # Add PostgreSQL (Render provides free DB)
   # Store hands, track progress over time
   ```

4. **Better Equity Calculation** - Use poker library
   ```bash
   pip install treys
   # Replace simplified equity calc with real Monte Carlo
   ```

---

## Cost Estimate

### Free Tier
- **Render:** 750 hours/month free (with sleep after 15 min inactivity)
- **Railway:** $5 credit/month free
- **Total:** $0/month (good for MVP/testing)

### Production Tier
- **Render Starter:** $7/month (always on)
- **Railway Pro:** ~$5-10/month (pay per usage)
- **Total:** ~$7-10/month

---

## Summary Checklist

✅ Generated `cfr_strategies.pkl` with `python cfr_trainer.py`  
✅ Tested locally with `python test_complete.py`  
✅ Pushed code to GitHub  
✅ Deployed to Render or Railway  
✅ Tested deployed API with `curl`  
✅ Connected Next.js frontend  
✅ Updated CORS settings  

**YOU'RE LIVE! 🎉**

Your poker AI is now accessible at:
- API: `https://poker-ai-backend.onrender.com`
- Docs: `https://poker-ai-backend.onrender.com/docs`

Time to get users and start making money! 💰🃏
